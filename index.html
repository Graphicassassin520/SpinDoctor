<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Spinnaker Incident Tracker</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

  <!-- TailwindCSS & Config -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gold: '#D4AF37',
            lgray: '#F8F7F6',
            dgray: '#1A1A1A'
          },
          fontFamily: {
            body: ['Montserrat','sans-serif'],
            heading: ['"Playfair Display"','serif']
          },
          keyframes: {
            fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
            slideIn: { '0%': { transform: 'translateX(-20px)' }, '100%': { transform: 'translateX(0)' } }
          },
          animation: {
            fadeIn: 'fadeIn 0.5s ease-out',
            slideIn: 'slideIn 0.5s ease-out'
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* Sticky filter bar */
    #filterBar { position: sticky; top: 0; z-index: 20; }
    /* Sticky table header */
    .table-header th {
      @apply sticky top-20 bg-gold text-dgray font-heading z-10;
    }
    /* Toast container */
    #toastContainer { position: fixed; bottom: 1rem; right: 1rem; z-index: 50; }
    .toast {
      @apply mb-2 px-4 py-2 bg-gold text-dgray rounded-lg shadow-lg flex items-center justify-between animate-fadeIn;
    }
    /* Error banner */
    #errorBanner {
      @apply fixed top-0 left-0 right-0 bg-red-600 text-white p-4 flex justify-between items-center z-50;
    }
    /* Table row hover */
    .log-row:hover {
      @apply shadow-lg shadow-gold/50 -translate-y-1 transition-all duration-200;
    }
  </style>
</head>

<body class="flex flex-col min-h-screen bg-lgray text-gray-900 dark:bg-dgray dark:text-gray-100 font-body">

  <!-- NAVBAR -->
  <nav class="flex items-center justify-between p-6 shadow-lg bg-white dark:bg-black/30">
    <h1 class="text-3xl font-heading text-gold">Spinnaker Incident Tracker</h1>
    <div class="space-x-4">
      <button id="tabTracker" class="px-4 py-2 border-2 border-gold text-gold hover:bg-gold hover:text-white rounded-lg transition">Tracker</button>
      <button id="tabAnalytics" class="px-4 py-2 border-2 border-gold text-gold hover:bg-gold hover:text-white rounded-lg transition">Analytics</button>
      <button id="themeToggle" class="px-4 py-2 border-2 border-gold text-gold hover:bg-gold hover:text-white rounded-lg transition">Toggle Theme</button>
    </div>
  </nav>

  <!-- ERROR BANNER -->
  <div id="errorBanner" class="hidden">
    <span id="errorMsg">Error!</span>
    <div class="space-x-4">
      <button id="retryBtn" class="underline">Retry</button>
      <button id="dismissError" class="text-2xl leading-none">&times;</button>
    </div>
  </div>

  <main class="flex-grow container mx-auto px-4 py-6 md:px-8 md:py-8 space-y-8">

    <!-- TRACKER -->
    <section id="trackerSection">

      <!-- LOGIN -->
      <div id="login" class="max-w-md mx-auto bg-white dark:bg-black/30 rounded-2xl shadow-2xl p-8 space-y-6">
        <h2 class="text-2xl font-heading text-center text-gold">Manager Login</h2>
        <select id="managerSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition">
          <option value="">Select Managerâ€¦</option>
        </select>
        <button id="loginBtn" class="w-full px-4 py-3 border-2 border-gold text-gold hover:bg-gold hover:text-white rounded-lg transition font-semibold">Enter</button>
      </div>

      <!-- FORM & TABLE -->
      <div id="tracker" class="hidden space-y-8 mt-8">

        <!-- GREETING & LOGOUT -->
        <div class="flex justify-between items-center">
          <p class="text-lg">Logged in as <span class="font-semibold" id="mgrName"></span></p>
          <button id="logoutBtn" class="px-4 py-2 border-2 border-red-600 text-red-600 hover:bg-red-600 hover:text-white rounded-lg transition">Logout</button>
        </div>

        <!-- INCIDENT FORM -->
        <div class="bg-white dark:bg-black/30 rounded-2xl shadow-2xl p-8 space-y-6 max-w-xl">
          <div class="grid grid-cols-1 gap-6">
            <div>
              <label class="block mb-2 font-medium">Sales Rep</label>
              <select id="repSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition">
                <option value="">Select Repâ€¦</option>
              </select>
            </div>
            <div>
              <label class="block mb-2 font-medium">Incident Type</label>
              <select id="typeSelect" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition">
                <option value="">Select Typeâ€¦</option>
                <option>Late</option>
                <option>Call In Sick</option>
                <option>No Call No Show</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block mb-2 font-medium">Notes (optional)</label>
            <textarea id="notes" rows="3" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition"></textarea>
          </div>
          <div class="flex flex-col md:flex-row gap-4">
            <button id="logBtn" class="flex-1 px-6 py-3 border-2 border-gold text-gold hover:bg-gold hover:text-white rounded-lg transition font-semibold">Log Incident</button>
            <button id="voiceBtn" class="flex-1 px-6 py-3 border-2 border-gold text-gold hover:bg-gold hover:text-white rounded-lg transition font-semibold">
              ðŸŽ¤ Voice Command
            </button>
          </div>
        </div>

        <!-- BULK ACTIONS BAR -->
        <div id="bulkBar" class="bg-white dark:bg-black/30 rounded-2xl shadow-2xl p-4 md:p-6 flex flex-col md:flex-row items-start md:items-center space-y-3 md:space-y-0 md:space-x-4 sticky top-20 z-10">
          <input type="checkbox" id="bulkSelectAll" class="form-checkbox h-5 w-5 text-gold rounded"/>
          <label for="bulkSelectAll" class="font-medium">Select All</label>
          <select id="bulkActionSelect" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition flex-1">
            <option value="">Bulk Actionâ€¦</option>
            <option value="Late">Mark Late</option>
            <option value="Call In Sick">Mark Sick</option>
            <option value="No Call No Show">Mark No Show</option>
          </select>
          <button id="bulkApplyBtn" class="px-4 py-2 border-2 border-gold text-gold hover:bg-gold hover:text-white rounded-lg transition">Apply</button>
        </div>

        <!-- FILTER BAR -->
        <div id="filterBar" class="bg-white dark:bg-black/30 rounded-2xl shadow-2xl p-6 mb-4 sticky top-28 z-10">
          <div class="flex flex-wrap gap-4">
            <select id="filterRep" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition">
              <option value="">All Reps</option>
            </select>
            <select id="filterType" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition">
              <option value="">All Types</option>
              <option>Late</option>
              <option>Call In Sick</option>
              <option>No Call No Show</option>
            </select>
            <input type="date" id="filterFrom" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition"/>
            <input type="date" id="filterTo" class="p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition"/>
            <input type="text" id="filterSearch" placeholder="Search notesâ€¦" class="flex-1 p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold focus:border-gold transition"/>
          </div>
        </div>

        <!-- LOG TABLE -->
        <div class="overflow-x-auto max-h-[50vh]">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="table-header">
              <tr>
                <th class="px-4 py-3"><input type="checkbox" id="selectAllHeader" class="form-checkbox h-5 w-5 text-gold rounded"/></th>
                <th class="px-4 py-3">#</th>
                <th class="px-4 py-3">Rep</th>
                <th class="px-4 py-3">Type</th>
                <th class="px-4 py-3">Time</th>
                <th class="px-4 py-3">By</th>
                <th class="px-4 py-3">Notes</th>
                <th class="px-4 py-3">Actions</th>
              </tr>
            </thead>
            <tbody id="logTableBody" class="bg-white dark:bg-black/20 divide-y divide-gray-100 dark:divide-gray-800">
              <!-- injected via JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ANALYTICS -->
    <section id="analyticsSection" class="hidden space-y-8 mt-8">
      <h2 class="text-2xl font-heading text-gold">Analytics</h2>
      <div class="grid md:grid-cols-2 gap-8">
        <div class="bg-white dark:bg-black/30 rounded-2xl shadow-2xl p-6"><canvas id="repChart"></canvas></div>
        <div class="bg-white dark:bg-black/30 rounded-2xl shadow-2xl p-6"><canvas id="typeChart"></canvas></div>
        <div class="bg-white dark:bg-black/30 rounded-2xl shadow-2xl p-6 md:col-span-2"><canvas id="monthChart"></canvas></div>
      </div>
    </section>

  </main>

  <!-- TOASTS -->
  <div id="toastContainer"></div>

  <script>
    // Data & elements
    const managers = [ "Stuart, John","Sents, Mathu","Rankin, Jeremy","Bentzoni, Chadd","Damon Robinson","Tami Tarver" ];
    const reps = [ "Palumbo, Steve","Perryman, Michael","McGuire, Steve","Jeanette, Anthony","St John, Heather","Cassata, John","Kelly, Meghan","Gustin, Charles","Gulley, Keviin","Luttenbacher, Charles","Roman, Joel","Wilson, Mary Ann","Stapleton, Kyle","Shell, Clayton","Panameno, Michael","Pozza, John","Roman, Cee Cee","Hurst, Clarence","Laloo, Shiva" ];
    let logs = JSON.parse(localStorage.getItem('incidentLogs')||'[]');
    let currentManager = null, editingIndex = null, lastSaveCallback = null;

    // Refs
    const body = document.documentElement;
    const mgrSelect = document.getElementById('managerSelect');
    const repSelect = document.getElementById('repSelect');
    const filterRep = document.getElementById('filterRep');
    const filterType = document.getElementById('filterType');
    const filterFrom = document.getElementById('filterFrom');
    const filterTo = document.getElementById('filterTo');
    const filterSearch = document.getElementById('filterSearch');
    const mgrNameEl = document.getElementById('mgrName');
    const logTableBody = document.getElementById('logTableBody');
    const loginDiv = document.getElementById('login');
    const trackerDiv = document.getElementById('tracker');
    const analyticsDiv = document.getElementById('analyticsSection');
    const errorBanner = document.getElementById('errorBanner');
    const errorMsg = document.getElementById('errorMsg');
    const retryBtn = document.getElementById('retryBtn');
    const dismissError = document.getElementById('dismissError');
    const toastContainer = document.getElementById('toastContainer');
    const bulkSelectAll = document.getElementById('bulkSelectAll');
    const selectAllHeader = document.getElementById('selectAllHeader');
    const bulkActionSelect = document.getElementById('bulkActionSelect');
    const bulkApplyBtn = document.getElementById('bulkApplyBtn');

    let repChart, typeChart, monthChart;

    // Save with error handling
    function saveLogs(cb) {
      lastSaveCallback = cb;
      try {
        localStorage.setItem('incidentLogs', JSON.stringify(logs));
        hideError();
        cb();
      } catch {
        showError("Couldn't save incidentâ€”retry?", retrySave);
      }
    }
    function retrySave() { if (lastSaveCallback) saveLogs(lastSaveCallback); }

    // Error banner
    function showError(msg, onRetry) {
      errorMsg.textContent = msg;
      retryBtn.onclick = onRetry;
      errorBanner.classList.remove('hidden');
    }
    function hideError() { errorBanner.classList.add('hidden'); }
    dismissError.onclick = hideError;

    // Toasts
    function showToast(txt) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerHTML = `<span>${txt}</span><button class="ml-4 font-bold">&times;</button>`;
      toastContainer.appendChild(t);
      const rm = () => t.remove();
      t.querySelector('button').onclick = rm;
      setTimeout(rm,3000);
    }

    // Tabs & theme
    document.getElementById('tabTracker').onclick = () => showSection('tracker');
    document.getElementById('tabAnalytics').onclick = () => { showSection('analytics'); updateCharts(); };
    document.getElementById('themeToggle').onclick = () => {
      body.classList.toggle('dark');
      localStorage.setItem('theme', body.classList.contains('dark')?'dark':'light');
    };
    if(localStorage.getItem('theme')==='dark') body.classList.add('dark');
    function showSection(s){ trackerDiv.classList.toggle('hidden',s!=='tracker'); analyticsDiv.classList.toggle('hidden',s!=='analytics'); }

    // Populate dropdowns
    managers.forEach(m=>mgrSelect.insertAdjacentHTML('beforeend',`<option>${m}</option>`));
    reps.forEach(r=> {
      repSelect.insertAdjacentHTML('beforeend',`<option>${r}</option>`);
      filterRep.insertAdjacentHTML('beforeend',`<option>${r}</option>`);
    });

    // Login/logout
    document.getElementById('loginBtn').onclick = () => {
      const m = mgrSelect.value; if(!m) return alert('Select manager');
      currentManager=m; mgrNameEl.textContent=m;
      loginDiv.classList.add('hidden'); trackerDiv.classList.remove('hidden');
      renderLogs(); initCharts();
    };
    document.getElementById('logoutBtn').onclick = () => {
      currentManager=null; editingIndex=null;
      loginDiv.classList.remove('hidden'); trackerDiv.classList.add('hidden');
      mgrSelect.value='';
    };

    // Log/update handler
    document.getElementById('logBtn').onclick = () => {
      const rep=repSelect.value, type=document.getElementById('typeSelect').value;
      const notes=document.getElementById('notes').value.trim();
      if(!rep||!type) return alert('Rep & Type required');
      const action = () => {
        if(editingIndex!==null) {
          logs[editingIndex]={...logs[editingIndex],rep,type,notes,manager:currentManager,time:Date.now()};
          showToast(`Updated incident for ${rep}`);
          editingIndex=null; document.getElementById('logBtn').textContent='Log Incident';
        } else {
          logs.push({rep,type,notes,manager:currentManager,time:Date.now()});
          showToast(`Incident logged for ${rep}`);
        }
        repSelect.value=''; document.getElementById('typeSelect').value=''; document.getElementById('notes').value='';
        renderLogs();
      };
      saveLogs(action);
    };

    // Bulk actions
    selectAllHeader.onchange = bulkSelectAll.onchange = () => {
      const chk = bulkSelectAll.checked||selectAllHeader.checked;
      document.querySelectorAll('.row-checkbox').forEach(cb=>cb.checked=chk);
      bulkSelectAll.checked=selectAllHeader.checked=chk;
    };
    bulkApplyBtn.onclick = () => {
      const type=bulkActionSelect.value; if(!type) return alert('Choose action');
      const idxs=Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb=>+cb.dataset.idx);
      if(!idxs.length) return alert('No rows selected');
      const action = () => {
        idxs.forEach(i=>{ logs[i].type=type; logs[i].manager=currentManager; logs[i].time=Date.now(); });
        showToast(`Applied "${type}" to ${idxs.length} rows`);
        renderLogs();
      };
      saveLogs(action);
    };

    // Filters
    [filterRep,filterType,filterFrom,filterTo,filterSearch].forEach(el=>el.oninput=renderLogs);

    // Render table
    function renderLogs() {
      const fr=filterRep.value, ft=filterType.value, fF=filterFrom.value, fT=filterTo.value, fs=filterSearch.value.toLowerCase();
      const filtered = logs.filter(e=>{
        if(fr&&e.rep!==fr) return false;
        if(ft&&e.type!==ft) return false;
        if(fF&&new Date(e.time)<new Date(fF)) return false;
        if(fT&&new Date(e.time)>new Date(fT+'T23:59:59')) return false;
        if(fs&&!(e.notes||'').toLowerCase().includes(fs)) return false;
        return true;
      });

      logTableBody.innerHTML='';
      filtered.forEach((e,i)=>{
        const idx=logs.indexOf(e);
        const time=new Date(e.time).toLocaleString();
        const tr=document.createElement('tr');
        tr.className='log-row animate-fadeIn';
        tr.innerHTML=`
          <td class="px-4 py-3"><input type="checkbox" data-idx="${idx}" class="row-checkbox form-checkbox h-5 w-5 text-gold rounded"/></td>
          <td class="px-4 py-3 text-center">${i+1}</td>
          <td class="px-4 py-3">${e.rep}</td>
          <td class="px-4 py-3">${e.type}</td>
          <td class="px-4 py-3">${time}</td>
          <td class="px-4 py-3">${e.manager}</td>
          <td class="px-4 py-3">${e.notes||''}</td>
          <td class="px-4 py-3 space-x-2 text-center">
            <button data-idx="${idx}" class="edit-btn px-3 py-1 border-2 border-gold text-gold hover:bg-gold hover:text-white rounded-lg transition text-sm">Edit</button>
            <button data-idx="${idx}" class="del-btn px-3 py-1 border-2 border-red-600 text-red-600 hover:bg-red-600 hover:text-white rounded-lg transition text-sm">Del</button>
          </td>`;
        logTableBody.appendChild(tr);
      });

      // Attach handlers
      document.querySelectorAll('.del-btn').forEach(b=>b.onclick=()=>{
        const i=+b.dataset.idx;
        if(!confirm('Delete this entry?')) return;
        const action=()=>{
          logs.splice(i,1);
          showToast('Entry deleted');
          renderLogs(); updateCharts();
        };
        saveLogs(action);
      });
      document.querySelectorAll('.edit-btn').forEach(b=>b.onclick=()=>{
        const i=+b.dataset.idx, e=logs[i];
        repSelect.value=e.rep;
        document.getElementById('typeSelect').value=e.type;
        document.getElementById('notes').value=e.notes;
        editingIndex=i;
        document.getElementById('logBtn').textContent='Update';
      });

      updateCharts();
    }

    // Charts
    function initCharts() {
      const opts={animation:{duration:800,easing:'easeOutQuart'}};
      repChart=new Chart(document.getElementById('repChart').getContext('2d'),{
        type:'bar',data:{labels:[],datasets:[{label:'Incidents by Rep',data:[],backgroundColor:'rgba(212,175,55,0.8)'}]},options:opts
      });
      typeChart=new Chart(document.getElementById('typeChart').getContext('2d'),{
        type:'pie',data:{labels:[],datasets:[{label:'By Type',data:[],backgroundColor:['#D4AF37','#E63946','#457B9D']}]},options:opts
      });
      monthChart=new Chart(document.getElementById('monthChart').getContext('2d'),{
        type:'bar',data:{labels:[],datasets:[{label:'Incidents by Month',data:[],backgroundColor:'rgba(212,175,55,0.8)'}]},options:opts
      });
      updateCharts();
    }
    function updateCharts() {
      if(!repChart) return;
      const byRep={},byType={},byMonth={};
      logs.forEach(e=>{
        byRep[e.rep]=(byRep[e.rep]||0)+1;
        byType[e.type]=(byType[e.type]||0)+1;
        const d=new Date(e.time),key=`${d.getMonth()+1}/${d.getFullYear()}`;
        byMonth[key]=(byMonth[key]||0)+1;
      });
      repChart.data.labels=Object.keys(byRep);
      repChart.data.datasets[0].data=Object.values(byRep);
      repChart.update();
      typeChart.data.labels=Object.keys(byType);
      typeChart.data.datasets[0].data=Object.values(byType);
      typeChart.update();
      const sorted=Object.entries(byMonth).sort((a,b)=>{
        const [am,ay]=a[0].split('/').map(Number),[bm,by_]=b[0].split('/').map(Number);
        return new Date(ay,am-1)-new Date(by_,bm-1);
      });
      monthChart.data.labels=sorted.map(x=>x[0]);
      monthChart.data.datasets[0].data=sorted.map(x=>x[1]);
      monthChart.update();
    }

    // Voice command
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      document.getElementById('voiceBtn').onclick = () => recognition.start();
      recognition.onresult = e => handleVoiceCommand(e.results[0][0].transcript);
      recognition.onerror = () => showToast('Voice recognition error');
    } else {
      document.getElementById('voiceBtn').disabled = true;
    }

    function handleVoiceCommand(speech) {
      const lower = speech.toLowerCase();
      if (!lower.startsWith('log incident for ')) {
        showToast('Unrecognized command');
        return;
      }
      const rest = speech.slice(17);
      const parts = rest.split(':');
      const repName = parts[0].trim();
      const matched = reps.find(r => r.toLowerCase().includes(repName.toLowerCase()));
      if (!matched) {
        showToast(`Unknown rep "${repName}"`);
        return;
      }
      repSelect.value = matched;
      const notePart = parts[1] ? parts[1].trim() : '';
      document.getElementById('notes').value = notePart;
      let typeVal = 'Late';
      if (lower.includes('late')) typeVal = 'Late';
      else if (lower.includes('sick')) typeVal = 'Call In Sick';
      else if (lower.includes('no call no show')) typeVal = 'No Call No Show';
      document.getElementById('typeSelect').value = typeVal;
      document.getElementById('logBtn').click();
    }
  </script>
</body>
</html>
